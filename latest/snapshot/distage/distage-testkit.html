<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="microsite">
<meta name="generator" content="Paradox, paradox-material-theme=0.10.17-SNAPSHOT, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="microsite">
<link rel="shortcut icon" href="../assets/images/favicon.png">
<title>distage-testkit Â· Izumi Project</title>
<link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../lib/prettify/prettify.css">
<script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../index.html" title="Izumi Project" class="md-header-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
Izumi Project
</span>
<span class="md-header-nav__topic">
distage-testkit
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/7mind/izumi"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
7mind/izumi
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../index.html" title="Izumi Project" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
<a href="../index.html" title="Izumi Project">
Izumi Project
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/7mind/izumi"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
7mind/izumi
</div>
</a>

</div>
<ul>
  <li><a href="../distage/index.html" class="page">distage: Staged Dependency Injection</a>
  <ul>
    <li><a href="../distage/basics.html" class="page">Basics</a></li>
    <li><a href="../distage/advanced-features.html" class="page">Advanced Features</a></li>
    <li><a href="../distage/debugging.html" class="page">Debugging</a></li>
    <li><a href="../distage/distage-framework.html" class="page">distage-framework</a></li>
    <li><a href="../distage/distage-framework-docker.html" class="page">distage-framework-docker</a></li>
    <li><a href="../distage/distage-testkit.html" class="active page">distage-testkit</a></li>
    <li><a href="../distage/reference.html" class="page">Syntax Summary</a></li>
  </ul></li>
  <li><a href="../logstage/index.html" class="page">LogStage</a></li>
  <li><a href="../bio/index.html" class="page">BIO</a></li>
  <li><a href="../idealingua/index.html" class="page">IdeaLingua RPC/DML</a>
  <ul>
    <li><a href="../idealingua/language-reference.html" class="page">Idealingua Language Reference</a></li>
    <li><a href="../idealingua/json.html" class="page">JSON Wire Format</a></li>
    <li><a href="../idealingua/cogen.html" class="page">Code generator reference</a></li>
    <li><a href="../idealingua/cogen-circe.html" class="page">Circe serialization reference</a></li>
  </ul></li>
  <li><a href="../sbt/index.html" class="page">SBT Toolkit</a></li>
  <li><a href="../manifesto/index.html" class="page">Productivity and challenges</a></li>
  <li><a href="../pper/index.html" class="page">PPER Pattern</a></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../distage/distage-testkit.html#distage-testkit" class="header">distage-testkit</a>
  <ul>
    <li><a href="../distage/distage-testkit.html#quick-start" class="header">Quick Start</a></li>
    <li><a href="../distage/distage-testkit.html#api-overview" class="header">API Overview</a></li>
    <li><a href="../distage/distage-testkit.html#syntax-summary" class="header">Syntax Summary</a></li>
    <li><a href="../distage/distage-testkit.html#resource-reuse-memoization" class="header">Resource Reuse - Memoization</a></li>
    <li><a href="../distage/distage-testkit.html#test-selection" class="header">Test Selection</a></li>
    <li><a href="../distage/distage-testkit.html#parallel-execution" class="header">Parallel Execution</a></li>
    <li><a href="../distage/distage-testkit.html#references" class="header">References</a></li>
    <li><a href="../distage/distage-testkit.html#additional-example-code" class="header">Additional example code</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 0.10.17*
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../distage/distage-testkit.html#distage-testkit" class="header">distage-testkit</a>
  <ul>
    <li><a href="../distage/distage-testkit.html#quick-start" class="header">Quick Start</a></li>
    <li><a href="../distage/distage-testkit.html#api-overview" class="header">API Overview</a></li>
    <li><a href="../distage/distage-testkit.html#syntax-summary" class="header">Syntax Summary</a></li>
    <li><a href="../distage/distage-testkit.html#resource-reuse-memoization" class="header">Resource Reuse - Memoization</a></li>
    <li><a href="../distage/distage-testkit.html#test-selection" class="header">Test Selection</a></li>
    <li><a href="../distage/distage-testkit.html#parallel-execution" class="header">Parallel Execution</a></li>
    <li><a href="../distage/distage-testkit.html#references" class="header">References</a></li>
    <li><a href="../distage/distage-testkit.html#additional-example-code" class="header">Additional example code</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#distage-testkit" name="distage-testkit" class="anchor"><span class="anchor-link"></span></a>distage-testkit</h1>
<div class="toc ">
<ul>
  <li><a href="../distage/distage-testkit.html#quick-start" class="header">Quick Start</a></li>
  <li><a href="../distage/distage-testkit.html#api-overview" class="header">API Overview</a>
  <ul>
    <li><a href="../distage/distage-testkit.html#distagespecscalatest-base-classes" class="header"><code>DistageSpecScalatest</code> Base Classes</a></li>
    <li><a href="../distage/distage-testkit.html#test-cases" class="header">Test Cases</a></li>
    <li><a href="../distage/distage-testkit.html#test-cases-assertions" class="header">Test Cases - Assertions</a></li>
    <li><a href="../distage/distage-testkit.html#assertions-with-effects" class="header">Assertions with Effects</a></li>
    <li><a href="../distage/distage-testkit.html#assertions-with-effects-with-environments" class="header">Assertions with Effects with Environments</a></li>
    <li><a href="../distage/distage-testkit.html#pattern-dual-test-tactic" class="header">Pattern: Dual Test Tactic</a></li>
    <li><a href="../distage/distage-testkit.html#test-case-context" class="header">Test Case Context</a></li>
    <li><a href="../distage/distage-testkit.html#configuration" class="header">Configuration</a></li>
  </ul></li>
  <li><a href="../distage/distage-testkit.html#syntax-summary" class="header">Syntax Summary</a></li>
  <li><a href="../distage/distage-testkit.html#resource-reuse-memoization" class="header">Resource Reuse - Memoization</a></li>
  <li><a href="../distage/distage-testkit.html#test-selection" class="header">Test Selection</a>
  <ul>
    <li><a href="../distage/distage-testkit.html#using-integrationcheck" class="header">Using <code>IntegrationCheck</code></a></li>
  </ul></li>
  <li><a href="../distage/distage-testkit.html#parallel-execution" class="header">Parallel Execution</a></li>
  <li><a href="../distage/distage-testkit.html#references" class="header">References</a></li>
  <li><a href="../distage/distage-testkit.html#additional-example-code" class="header">Additional example code</a></li>
</ul>
</div>
<h3><a href="#quick-start" name="quick-start" class="anchor"><span class="anchor-link"></span></a>Quick Start</h3>
<p>The <code>distage-testkit</code> simplifies pragmatic pure functional programming testing. <code>DistageSpecScalatest</code> are <a href="https://www.scalatest.org/">ScalaTest</a> base classes for the effect types of <code>Identity</code>, <code>F[_]</code>, <code>F[+_, +_]</code> and <code>F[-_, +_, +_]</code>. They provide an interface similar to ScalaTest&rsquo;s <a href="http://doc.scalatest.org/3.1.0/org/scalatest/wordspec/AnyWordSpec.html"><code>WordSpec</code></a>, however <code>distage-testkit</code> has additional capabilities such as first class support for effect types and dependency injection.</p>
<p>Usage of <code>distage-testkit</code> generally follows these steps:</p>
<ol>
  <li>Extend a base class corresponding to the effect type:
    <ul>
      <li>No effect type - <a href="/latest/snapshot/api/izumi/distage/testkit/scalatest/DistageSpecScalatest.html"><code>DistageSpecScalatest[Identity]</code></a></li>
      <li><code>F[_]</code> - <a href="/latest/snapshot/api/izumi/distage/testkit/scalatest/DistageSpecScalatest.html"><code>DistageSpecScalatest[F]</code></a></li>
      <li><code>F[+_, +_]</code> - <a href="/latest/snapshot/api/izumi/distage/testkit/scalatest/DistageBIOSpecScalatest.html"><code>DistageBIOSpecScalatest[F]</code></a></li>
      <li><code>F[-_, +_, +_]</code> - <a href="/latest/snapshot/api/izumi/distage/testkit/scalatest/DistageBIOEnvSpecScalatest.html"><code>DistageBIOEnvSpecScalatest[F]</code></a></li>
    </ul>
  </li>
  <li>Override <code>def config: TestConfig</code> to customize the <a href="/latest/snapshot/api/izumi/distage/testkit/TestConfig.html"><code>TestConfig</code></a></li>
  <li>Establish test case contexts using <a href="https://www.scalatest.org/scaladoc/3.2.0/org/scalatest/verbs/ShouldVerb.html"><code>should</code></a>,  <a href="https://www.scalatest.org/scaladoc/3.2.0/org/scalatest/verbs/MustVerb.html"><code>must</code></a>,  and <a href="https://www.scalatest.org/scaladoc/3.2.0/org/scalatest/verbs/CanVerb.html"><code>can</code></a>.</li>
  <li>Introduce test cases using one of the <code>in</code> methods. These test cases can have a variety of forms, from  pure functions returning an  <a href="https://www.scalatest.org/scaladoc/3.2.0/org/scalatest/Assertions.html">assertion</a>, to effectful  functions with dependencies:
    <ul>
      <li>No effect type / <code>Identity</code> - <a href="/latest/snapshot/api/izumi/distage/testkit/services/scalatest/dstest/DistageAbstractScalatestSpec$$LowPriorityIdentityOverloads.html"><code>in</code></a></li>
      <li><a href="/latest/snapshot/api/izumi/distage/testkit/services/scalatest/dstest/DistageAbstractScalatestSpec$$DSWordSpecStringWrapper.html"><code>in</code> for <code>F[_]</code></a></li>
      <li><a href="/latest/snapshot/api/izumi/distage/testkit/services/scalatest/dstest/DistageAbstractScalatestSpec$$DSWordSpecStringWrapper2.html"><code>in</code> for <code>F[+_, +_]</code></a></li>
      <li><a href="/latest/snapshot/api/izumi/distage/testkit/services/scalatest/dstest/DistageAbstractScalatestSpec$$DSWordSpecStringWrapper3.html"><code>in</code> for <code>F[-_, +_, +_]</code></a></li>
      <li>Magnet for test cases dependent on injectables: <a href="/latest/snapshot/api/izumi/distage/model/providers/Functoid.html"><code>Functoid</code></a></li>
    </ul>
  </li>
</ol>
<h3><a href="#api-overview" name="api-overview" class="anchor"><span class="anchor-link"></span></a>API Overview</h3>
<p>The highest value tests to develop <a href="https://blog.7mind.io/constructive-test-taxonomy.html">in our experience</a> are those that verify the communication behavior of components. These are tests of blackbox interfaces, with atomic or group isolation levels.</p>
<p>To demonstrate usage of <code>distage-testkit</code> we&rsquo;ll consider a hypothetical game score system. This system will have a model, logic, and service which we&rsquo;ll then define test cases to verify. Our application will use <code>ZIO[-R, +E, +A]</code>.</p>
<p>We&rsquo;ll start with the following model and service interface for the game score system:</p>
<pre class="prettyprint"><code class="language-scala">package app

import zio._
import zio.console.{Console, putStrLn}

case class Score(value: Int)

case class Config(starValue: Int, mangoValue: Int)

trait BonusService {
  def queryCurrentBonus: Task[Int]
}

object Score {
  val zero = Score(0)

  def addStar(config: Config, score: Score) =
    score.copy(value = score.value + config.starValue)

  def echoConfig(config: Config): RIO[Has[Console.Service], Config] =
    for {
      _ &lt;- putStrLn(config.toString)
    } yield config

  def addMango(config: Config, score: Score): RIO[Has[Console.Service] with Has[BonusService], Score] =
    for {
      bonusService &lt;- RIO.service[BonusService]
      currentBonus &lt;- bonusService.queryCurrentBonus
    } yield {
      val value = score.value + config.mangoValue + currentBonus
      score.copy(value = value)
    }
}
</code></pre>
<p>This represents a game score system where the player can collect Stars or Mangoes with differently configured and calculated point values.</p>
<h4><a href="#distagespecscalatest-base-classes" name="distagespecscalatest-base-classes" class="anchor"><span class="anchor-link"></span></a><code>DistageSpecScalatest</code> Base Classes</h4>
<p>There are test suite base classes for functor, bifunctor and trifunctor effect types. We will be choosing the one that matches our application&rsquo;s effect type from the following:</p>
<ul>
  <li>No effect type - <a href="/latest/snapshot/api/izumi/distage/testkit/scalatest/DistageSpecScalatest.html"><code>DistageSpecScalatest[Identity]</code></a></li>
  <li><code>F[_]</code> - <a href="/latest/snapshot/api/izumi/distage/testkit/scalatest/DistageSpecScalatest.html"><code>DistageSpecScalatest[F]</code></a></li>
  <li><code>F[+_, +_]</code> - <a href="/latest/snapshot/api/izumi/distage/testkit/scalatest/DistageBIOSpecScalatest.html"><code>DistageBIOSpecScalatest[F]</code></a></li>
  <li><code>F[-_, +_, +_]</code> - <a href="/latest/snapshot/api/izumi/distage/testkit/scalatest/DistageBIOEnvSpecScalatest.html"><code>DistageBIOEnvSpecScalatest[F]</code></a></li>
</ul>
<p>For our demonstration application the tests use the <code>ZIO[-R, +E, +A]</code> effect type. This means we&rsquo;ll be using <code>DistageBIOEnvSpecScalatest</code> for the test suite base class.</p>
<p>The default config (<code>super.config</code>) has <code>pluginConfig</code>, which will scan the package the test is in for according modules. See the <a href="distage-framework.html#plugins"><code>distage-extension-plugins</code></a> documentation for more information. For our demonstration the module will be provided using <code>moduleOverrides</code> like so:</p>
<pre class="prettyprint"><code class="language-scala">package app

import com.typesafe.config.ConfigFactory
import distage.config.AppConfigModule
import distage.ModuleDef
import izumi.distage.effect.modules.ZIODIEffectModule
import izumi.distage.testkit.scalatest.{AssertIO, DistageBIOEnvSpecScalatest}

abstract class Test extends DistageBIOEnvSpecScalatest[ZIO] with AssertIO {
  val defaultConfig = Config(starValue = 10, mangoValue = 256)

  override def config = super
    .config.copy(
      moduleOverrides = new ModuleDef {
        include(AppConfigModule(ConfigFactory.defaultApplication))
        include(ZIODIEffectModule)
        make[Config].from(defaultConfig)
        make[Console.Service].fromHas(Console.live)
      }
    )
}
</code></pre>
<h4><a href="#test-cases" name="test-cases" class="anchor"><span class="anchor-link"></span></a>Test Cases</h4>
<p>In <code>WordSpec</code>, a test case is a sentence (a <code>String</code>) followed by <code>in</code> then the body. In <code>distage-testkit</code> the body of the test case is not limited to a function returning an <a href="https://www.scalatest.org/scaladoc/3.2.0/org/scalatest/Assertions.html">assertion</a>. <a href="/latest/snapshot/api/izumi/distage/model/providers/Functoid.html">Functions that take arguments</a> and functions using effect types are also supported. Function arguments and effect environments will be provided according to the <code>distage</code> object graph.</p>
<h4><a href="#test-cases-assertions" name="test-cases-assertions" class="anchor"><span class="anchor-link"></span></a>Test Cases - Assertions</h4>
<p>All of the base classes support test cases that are:  - Assertions.  - Functions returning an assertion.  - Functions returning unit that fail on exception.</p>
<p>These are introduced using <code>in</code> from <a href="/latest/snapshot/api/izumi/distage/testkit/services/scalatest/dstest/DistageAbstractScalatestSpec$$LowPriorityIdentityOverloads.html">DistageAbstractScalatestSpec.LowPriorityIdentityOverloads</a></p>
<p>The assertion methods are the same as ScalaTest as the base classes extend <a href="https://www.scalatest.org/scaladoc/3.2.0/org/scalatest/Assertions.html">ScalaTest Assertions</a>.</p>
<p>Let&rsquo;s now create a simple test for our demonstration application:</p>
<pre class="prettyprint"><code class="language-scala">package app

final class ScoreSimpleTest extends Test {
  &quot;Score&quot; should {

    &quot;increase by config star value&quot; in {
      val starValue = util.Random.nextInt()
      val mangoValue = util.Random.nextInt()
      val config = Config(starValue, mangoValue)
      val expected = Score(starValue)
      val actual = Score.addStar(config, Score.zero)
      assert(actual == expected)
    }

    // Use Config is from the module in the `Test` class above
    &quot;increase by config start value from DI&quot; in {
      config: Config =&gt;
        val expected = Score(defaultConfig.starValue)
        val actual = Score.addStar(config, Score.zero)
        assert(actual == expected)
    }
  }
}
</code></pre>
<h4><a href="#assertions-with-effects" name="assertions-with-effects" class="anchor"><span class="anchor-link"></span></a>Assertions with Effects</h4>
<p>All of the base classes support test cases that are effects with assertions. As mentioned earlier, functions returning effects will have arguments provided from the <code>distage</code> object graph. These test cases are supported by <a href="/latest/snapshot/api/izumi/distage/testkit/services/scalatest/dstest/DistageAbstractScalatestSpec$$DSWordSpecStringWrapper.html"><code>in</code> from DSWordSpecStringWrapper</a>.</p>
<p>The different effect types fix the <code>F[_]</code> argument for this syntax:</p>
<ul>
  <li><code>DistageSpecScalatest</code>: <code>F[_]</code></li>
  <li><code>DistageBIOSpecScalatest</code>: <code>F[Throwable, _]</code></li>
  <li><code>DistageBIOEnvSpecScalatest</code>: <code>F[Any, Throwable, _]</code></li>
</ul>
<p>With our demonstration application we&rsquo;ll use this to verify the <code>Score.echoConfig</code> method. The <code>Config</code> required is from the <code>distage</code> object graph defined in <code>moduleOverrides</code>. By using a function from <code>Config</code>, the required argument will be injected by <code>distage-testkit</code>.</p>
<pre class="prettyprint"><code class="language-scala">package app

final class ScoreEffectsTest extends Test {
  &quot;testkit operations with effects&quot; should {

    &quot;assertions in effects&quot; in {
      (config: Config) =&gt;
        for {
          actual &lt;- Score.echoConfig(config)
          _ &lt;- assertIO(actual == config)
        } yield ()
    }

    &quot;assertions from effects&quot; in {
      (config: Config) =&gt;
        Score.echoConfig(config) map {
          actual =&gt; assert(actual == config)
        }
    }
  }
}
</code></pre>
<h4><a href="#assertions-with-effects-with-environments" name="assertions-with-effects-with-environments" class="anchor"><span class="anchor-link"></span></a>Assertions with Effects with Environments</h4>
<p><a href="/latest/snapshot/api/izumi/distage/testkit/services/scalatest/dstest/DistageAbstractScalatestSpec$$DSWordSpecStringWrapper3.html">The <code>in</code> method for <code>F[_, _, _]</code> effect types</a> supports injection of environments from the object graph in addition to simple assertions and assertions with effects.</p>
<p>A test that verifies the bonus service always returns a value of <code>1</code> in our demonstration would be:</p>
<pre class="prettyprint"><code class="language-scala">package app

abstract class BonusServiceIsZeroTest extends Test {
  &quot;BonusService&quot; should {
    &quot;return one&quot; in {
      for {
        bonusService &lt;- ZIO.service[BonusService]
        currentBonus &lt;- bonusService.queryCurrentBonus
        _ &lt;- putStrLn(s&quot;currentBonus = $currentBonus&quot;)
        _ &lt;- assertIO(currentBonus == 1)
      } yield ()
    }
  }
}
</code></pre>
<p>While this compiles this test cannot be run without the object graph containing a <code>BonusService</code> resource. For <code>ZIO[-R, +E, +A]</code>, the <code>Has</code> bindings are injected from <code>ZLayer</code>, <code>ZManaged</code> <code>ZIO</code> or any <code>F[_, _, _]: BIOLocal</code>. See <a href="basics.html#zio-has-bindings">here for details on ZIO Has injection </a>.</p>
<p>Our demonstration application has a dummy and production implementation of the <code>BonusService</code>. For each implementation, a <code>ZManaged</code> is provided. With the <code>ZManaged</code> resources added to the object graph test cases can inject <code>Has[BonusService]</code>.</p>
<p>For demonstration of <a href="#resource-reuse-memoization">reuse and memoization</a>, the bonus value will be equal to the number of times the resource was acquired.</p>
<pre class="prettyprint"><code class="language-scala">package app

object DummyBonusService {
  var acquireCount: Int = 0
  var releaseCount: Int = 0

  class Impl(bonusValue: Int) extends BonusService {
    override def queryCurrentBonus = UIO(bonusValue)
  }

  val acquire = Task {
    acquireCount += 1
    new Impl(acquireCount)
  }

  def release: UIO[Unit] = UIO {
    releaseCount += 1
  }

  val managed = acquire.toManaged(_ =&gt; release)
}
</code></pre>
<p>This small implementation is useful for verification in both automated tests as well as functional prototypes.</p>
<p>For a real system we&rsquo;d build a production implementation like the following. Such an implementation would perform an HTTP request to a REST service. We&rsquo;ll introduce a production service, but this actual query will be unimplemented for our demonstration:</p>
<pre class="prettyprint"><code class="language-scala">package app

object ProdBonusService {
  class Impl(console: Console.Service, url: String) extends BonusService {
    override def queryCurrentBonus = for {
      _ &lt;- console.putStrLn(s&quot;querying $url&quot;)
    } yield ???
  }

  val acquire = for {
    console &lt;- ZIO.service[Console.Service]
    impl &lt;- Task(new Impl(console, &quot;https://my-bonus-server/current-bonus.json&quot;))
  } yield impl

  def release: UIO[Unit] = UIO {
    ()
  }

  val managed = acquire.toManaged(_ =&gt; release)
}
</code></pre>
<h4><a href="#pattern-dual-test-tactic" name="pattern-dual-test-tactic" class="anchor"><span class="anchor-link"></span></a>Pattern: Dual Test Tactic</h4>
<p>The testing of <code>BonusService</code> in our demonstration application will follow the Dual Test Tactic. See our blog post <a href="https://blog.7mind.io/constructive-test-taxonomy.html">Unit, Functional, Integration? You are doing it wrong</a> for a discussion of test taxonomy and the value of this tactic.</p>
<p>A <code>ZIO</code> resource for <code>BonusService</code> must be in the <code>distage</code> object graph for a <code>Has[BonusService]</code> to be injected into the <code>ZIO</code> environment. One option is to define separate modules for the dummy and production implementations. One module would be referenced by tests and the other only by production. However, this is not as useful as both implementations in the same object graph but different activations.</p>
<p>Our demonstration application will use the <a href="/latest/snapshot/api/izumi/distage/model/definition/StandardAxis$$Repo$.html">StandardAxis.Repo</a> <code>Dummy</code> and <code>Prod</code> tags:</p>
<pre class="prettyprint"><code class="language-scala">package app

import distage.plugins.PluginDef
import distage.Activation
import distage.StandardAxis.Repo

object BonusServicePlugin extends PluginDef {
  make[BonusService]
    .fromHas(DummyBonusService.managed)
    .tagged(Repo.Dummy)

  make[BonusService]
    .fromHas(ProdBonusService.managed)
    .tagged(Repo.Prod)
}
</code></pre>
<p>Note that the <code>BonusServicePlugin</code> is not explicitly added to the <code>Test.config</code>: This <code>PluginDef</code> is in the same package as the test, namely <code>app</code>. By default the <code>pluginConfig</code> for the test will include the test&rsquo;s package, which will be scanned by <code>distage</code> for <code>PluginDef</code> instances.</p>
<p>Continuing with the pattern, a trait will control which repo is activated:</p>
<pre class="prettyprint"><code class="language-scala">package app

trait DummyTest extends Test {
  override def config = super
    .config.copy(
      activation = Activation(Repo -&gt; Repo.Dummy)
    )
}

trait ProdTest extends Test {
  override def config = super
    .config.copy(
      activation = Activation(Repo -&gt; Repo.Prod)
    )
}
</code></pre>
<p>With these a production test and a dummy test can be introduced for the demonstration game score application. Note how these are the same scenario, <code>BonusServiceIsZeroTest</code>, but differ in activations.</p>
<p>When extended beyond this small example, this pattern simplifies system level tests, sanity checks, and even a pragmatic form of <a href="https://en.wikipedia.org/wiki/N-version_programming">N-Version Programming</a>:</p>
<pre class="prettyprint"><code class="language-scala">package app

final class ProdBonusServiceIsZeroTest extends BonusServiceIsZeroTest with ProdTest

final class DummyBonusServiceIsZeroTest extends BonusServiceIsZeroTest with DummyTest
</code></pre>
<pre>
</pre>
<h4><a href="#test-case-context" name="test-case-context" class="anchor"><span class="anchor-link"></span></a>Test Case Context</h4>
<p>The <code>testkit</code> ScalaTest base classes include the following verbs for establishing test context:</p>
<ul>
  <li><a href="https://www.scalatest.org/scaladoc/3.2.0/org/scalatest/verbs/ShouldVerb.html"><code>should</code></a></li>
  <li><a href="https://www.scalatest.org/scaladoc/3.2.0/org/scalatest/verbs/MustVerb.html"><code>must</code></a></li>
  <li><a href="https://www.scalatest.org/scaladoc/3.2.0/org/scalatest/verbs/CanVerb.html"><code>can</code></a></li>
</ul>
<h4><a href="#configuration" name="configuration" class="anchor"><span class="anchor-link"></span></a>Configuration</h4>
<p>The test suite class for your application should override the <code>def config: TestConfig</code> attributed. The config defines the plugin configuration, module overrides and activation axes, and other options. See the <a href="/latest/snapshot/api/izumi/distage/testkit/TestConfig.html"><code>TestConfig</code> API docs</a> for more information.</p>
<h3><a href="#syntax-summary" name="syntax-summary" class="anchor"><span class="anchor-link"></span></a>Syntax Summary</h3>
<p>For <code>F[_]</code> including <code>Identity</code>:</p>
<ul>
  <li><code>in { assert(???) }</code>: The test case is a function returning an  <a href="https://www.scalatest.org/scaladoc/3.2.0/org/scalatest/Assertions.html">assertion</a>.</li>
  <li><code>in { (a: A, b: B) =&gt; assert(???) }</code>: The test case is a function returning an assertion. The <code>a</code> and  <code>b</code> will be injected from the object graph.</li>
  <li><code>in { (a: A, b: B) =&gt; ???: F[Unit] }</code>: The test case is a function returning an effect to be  executed. The <code>a</code> and <code>b</code> will be injected from the object graph. The test case will fail if the  effect fails.</li>
  <li><code>in { (a: A, b: B) =&gt; ???: F[Assertion] }</code>: The test case is a function returning an effect to be  executed. The <code>a</code> and <code>b</code> will be injected from the object graph. The test case will fail if the  effect fails or produces a failure assertion.</li>
</ul>
<p>For <code>F[-_, +_, +_]</code>, it&rsquo;s same with <code>F[Any, _, _]</code>:</p>
<ul>
  <li><code>in { ???: F[zio.Has[C] with zio.Has[D], _, Unit] }</code>: The test case is an effect requiring an  environment. The test case will fail if the effect fails. The environment will be injected from  the object graph.</li>
  <li><code>in { ???: F[zio.Has[C] with zio.Has[D], _, Assertion] }</code>: The test case is an effect  requiring an environment. The test case will fail if the effect fails or produces a failure  assertion. The environment will be injected from the object graph.</li>
  <li><code>in { (a: A, b: B) =&gt; ???: F[zio.Has[C] with zio.Has[D], _, Assertion] }</code>: The test case is a  function producing an effect requiring an environment. All of <code>a: A</code>, <code>b: B</code>, <code>Has[C]</code> and <code>Has[D]</code>  will be injected from the object graph.</li>
</ul>
<p>Provided by trait <a href="/latest/snapshot/api/izumi/distage/testkit/scalatest/AssertIO.html">AssertIO</a>:</p>
<ul>
  <li><code>assertIO(???: Boolean): zio.UIO[Assertion]</code></li>
</ul>
<p>Provided by trait <a href="/latest/snapshot/api/izumi/distage/testkit/scalatest/AssertCIO.html">AssertCIO</a>:</p>
<ul>
  <li><code>assertIO(???: Boolean): cats.effect.IO[Assertion]</code></li>
</ul>
<p>Provided by trait <a href="/latest/snapshot/api/izumi/distage/testkit/scalatest/AssertBIO.html">AssertBIO</a>:</p>
<ul>
  <li><code>assertBIO[F[+_, +_] : BIO](???: Boolean): F[Nothing, Assertion]</code></li>
</ul>
<h3><a href="#resource-reuse-memoization" name="resource-reuse-memoization" class="anchor"><span class="anchor-link"></span></a>Resource Reuse - Memoization</h3>
<p>Injected values are summoned from the dependency injection graph for each test. Without using memoization, resources will be acquired and released for each test. This may be unwanted. For instance, a single Postgres Docker may be wanted for all tests. The test config has a <a href="/latest/snapshot/api/izumi/distage/testkit/TestConfig.html#memoizationRoots"><code>memoizationRoots</code></a> property for sharing components across tests.</p>
<h3><a href="#test-selection" name="test-selection" class="anchor"><span class="anchor-link"></span></a>Test Selection</h3>
<h4><a href="#using-integrationcheck" name="using-integrationcheck" class="anchor"><span class="anchor-link"></span></a>Using <code>IntegrationCheck</code></h4>
<p>Implementation classes that inherit from <a href="/latest/snapshot/api/izumi/distage/framework/model/IntegrationCheck.html"><code>izumi.distage.framework.model.IntegrationCheck</code></a>. You can specify a <code>resourceCheck()</code> method that will be called before test instantiation to check if external test dependencies (such as Docker containers in <a href="distage-framework-docker.html#docker-test-resources">distage-framework-docker</a>) are available for the test or role. If not, the test will be canceled/ignored.</p>
<p>This feature allows you to therefore selectively run only the fast in-memory tests that have no external dependencies. Integration checks are executed only in <code>distage-testkit</code> tests and <code>distage-framework</code>&rsquo;s <a href="distage-framework.html#roles">Roles</a>.</p>
<p>Use <a href="/latest/snapshot/api/izumi/distage/roles/launcher/services/StartupPlanExecutor.html">StartupPlanExecutor</a> to execute the checks manually.</p>
<h3><a href="#parallel-execution" name="parallel-execution" class="anchor"><span class="anchor-link"></span></a>Parallel Execution</h3>
<p>TODO</p>
<h3><a href="#references" name="references" class="anchor"><span class="anchor-link"></span></a>References</h3>
<ul>
  <li>Slides for <a href="https://www.slideshare.net/7mind/hyperpragmatic-pure-fp-testing-with-distagetestkit">Hyper-pragmatic Pure FP testing with  distage-testkit</a></li>
  <li>Slides for <a href="https://www.slideshare.net/7mind/scala-functional-programming-and-team-productivity">Scala, Functional Programming and Team Productivity  </a></li>
  <li><a href="https://github.com/7mind/distage-example">distage Example Project</a> project shows how to use  <code>distage-testkit</code></li>
  <li>The <a href="https://www.youtube.com/watch?v=CzpvjkUukAs">Hyper-pragmatic Pure FP Testing with  distage-testkit</a> talk is an overview of the concepts,  design and usage.</li>
  <li>7mind&rsquo;s blog <a href="https://blog.7mind.io/constructive-test-taxonomy.html">Constructive Test Taxonomy</a></li>
  <li><a href="https://en.wikipedia.org/wiki/N-version_programming">N-Version Programming</a></li>
</ul>
<h2><a href="#additional-example-code" name="additional-example-code" class="anchor"><span class="anchor-link"></span></a>Additional example code</h2>
<p>Some example code from <a href="https://github.com/7mind/distage-example">distage-example</a>:</p>
<pre class="prettyprint"><code class="language-scala">import distage.{Activation, DIKey, ModuleDef}
import distage.StandardAxis.Repo
import distage.plugins.PluginConfig
import izumi.distage.testkit.TestConfig
import izumi.distage.testkit.scalatest.{AssertIO, DistageBIOEnvSpecScalatest}
import leaderboard.model.{Score, UserId}
import leaderboard.repo.{Ladder, Profiles}
import leaderboard.zioenv.{ladder, rnd}
import zio.{ZIO, IO}

abstract class LeaderboardTest extends DistageBIOEnvSpecScalatest[ZIO] with AssertIO {
  override def config = super.config.copy(
    pluginConfig = PluginConfig.cached(packagesEnabled = Seq(&quot;leaderboard.plugins&quot;)),
    moduleOverrides = new ModuleDef {
      make[Rnd[IO]].from[Rnd.Impl[IO]]
      // For testing, setup a docker container with postgres,
      // instead of trying to connect to an external database
      include(PostgresDockerModule)
    },
    // instantiate Ladder &amp; Profiles only once per test-run and
    // share them and all their dependencies across all tests.
    // this includes the Postgres Docker container above and
    // table DDLs
    memoizationRoots = Set(
      DIKey[Ladder[IO]],
      DIKey[Profiles[IO]],
    ),
  )
}

trait DummyTest extends LeaderboardTest {
  override final def config = super.config.copy(
    activation = Activation(Repo -&gt; Repo.Dummy),
  )
}

trait ProdTest extends LeaderboardTest {
  override final def config = super.config.copy(
    activation = Activation(Repo -&gt; Repo.Prod),
  )
}

final class LadderTestDummy extends LadderTest with DummyTest
final class LadderTestPostgres extends LadderTest with ProdTest

abstract class LadderTest extends LeaderboardTest {

  &quot;Ladder&quot; should {
    // this test gets dependencies through arguments
    &quot;submit &amp; get&quot; in {
      (rnd: Rnd[IO], ladder: Ladder[IO]) =&gt;
        for {
          user  &lt;- rnd[UserId]
          score &lt;- rnd[Score]
          _     &lt;- ladder.submitScore(user, score)
          res   &lt;- ladder.getScores.map(_.find(_._1 == user).map(_._2))
          _     &lt;- assertIO(res contains score)
        } yield ()
    }

    // other tests get dependencies via ZIO Env:
    &quot;assign a higher position in the list to a higher score&quot; in {
      for {
        user1  &lt;- rnd[UserId]
        score1 &lt;- rnd[Score]
        user2  &lt;- rnd[UserId]
        score2 &lt;- rnd[Score]

        _      &lt;- ladder.submitScore(user1, score1)
        _      &lt;- ladder.submitScore(user2, score2)
        scores &lt;- ladder.getScores

        user1Rank = scores.indexWhere(_._1 == user1)
        user2Rank = scores.indexWhere(_._1 == user2)

        _ &lt;- if (score1 &gt; score2) {
          assertIO(user1Rank &lt; user2Rank)
        } else if (score2 &gt; score1) {
          assertIO(user2Rank &lt; user1Rank)
        } else IO.unit
      } yield ()
    }

    // you can also mix arguments and env at the same time
    &quot;assign a higher position in the list to a higher score 2&quot; in {
      ladder: Ladder[IO] =&gt;
          for {
            user1  &lt;- rnd[UserId]
            score1 &lt;- rnd[Score]
            user2  &lt;- rnd[UserId]
            score2 &lt;- rnd[Score]

            _      &lt;- ladder.submitScore(user1, score1)
            _      &lt;- ladder.submitScore(user2, score2)
            scores &lt;- ladder.getScores

            user1Rank = scores.indexWhere(_._1 == user1)
            user2Rank = scores.indexWhere(_._1 == user2)

            _ &lt;- if (score1 &gt; score2) {
              assertIO(user1Rank &lt; user2Rank)
            } else if (score2 &gt; score1) {
              assertIO(user2Rank &lt; user1Rank)
            } else IO.unit
          } yield ()
    }
  }

}
</code></pre>
</div>
<div>
<a href="https://github.com/7mind/izumi/tree/master/doc/microsite/target/mdoc/distage/distage-testkit.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
0.10.17*
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../distage/distage-framework-docker.html" title="distage-framework-docker" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
distage-framework-docker
</span>
</div>
</a>
<a href="../distage/reference.html" title="Syntax Summary" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Syntax Summary
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
<div class="md-footer-copyright__highlight">
7mind.io
</div>
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="../assets/javascripts/application.583bbe55.js"></script>
<script src="../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../."}})</script>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
