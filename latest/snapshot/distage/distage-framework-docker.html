<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="microsite">
<meta name="generator" content="Paradox, paradox-material-theme=0.6.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="microsite">
<link rel="shortcut icon" href="../assets/images/favicon.png">
<title>distage-framework-docker · Izumi Project</title>
<link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../lib/prettify/prettify.css">
<script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../index.html" title="Izumi Project" class="md-header-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
Izumi Project
</span>
<span class="md-header-nav__topic">
distage-framework-docker
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/7mind/izumi"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
7mind/izumi
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../index.html" title="Izumi Project" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
<a href="../index.html" title="Izumi Project">
Izumi Project
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/7mind/izumi"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
7mind/izumi
</div>
</a>

</div>
<ul>
  <li><a href="../glossary.html" class="page">Izumi Glossary</a></li>
  <li><a href="../guidelines.html" class="page">Izumi Framework Best Practices</a></li>
  <li><a href="../bio/index.html" class="page">BIO Hierarchy</a></li>
  <li><a href="../logstage/index.html" class="page">LogStage</a></li>
  <li><a href="../distage/index.html" class="page">DIStage</a>
  <ul>
    <li><a href="../distage/basics.html" class="page">Overview</a></li>
    <li><a href="../distage/debugging.html" class="page">Debugging</a></li>
    <li><a href="../distage/advanced-features.html" class="page">Advanced Features</a></li>
    <li><a href="../distage/distage-framework.html" class="page">distage-framework</a></li>
    <li><a href="../distage/distage-framework-docker.html" class="active page">distage-framework-docker</a></li>
    <li><a href="../distage/distage-testkit.html" class="page">distage-testkit</a></li>
    <li><a href="../distage/reference.html" class="page">Syntax Reference</a></li>
  </ul></li>
  <li><a href="../idealingua/index.html" class="page">IdeaLingua</a>
  <ul>
    <li><a href="../idealingua/language-reference.html" class="page">Idealingua Language Reference</a></li>
    <li><a href="../idealingua/json.html" class="page">JSON Wire Format</a></li>
    <li><a href="../idealingua/cogen.html" class="page">Code generator reference</a></li>
    <li><a href="../idealingua/cogen-circe.html" class="page">Circe serialization reference</a></li>
  </ul></li>
  <li><a href="../sbt/index.html" class="page">SBT Notes</a></li>
  <li><a href="../manifesto/index.html" class="page">Productivity and challenges</a></li>
  <li><a href="../pper/index.html" class="page">PPER Pattern</a></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../distage/distage-framework-docker.html#distage-framework-docker" class="header">distage-framework-docker</a>
  <ul>
    <li><a href="../distage/distage-framework-docker.html#key-features" class="header">Key Features</a></li>
    <li><a href="../distage/distage-framework-docker.html#dependencies" class="header">Dependencies</a></li>
    <li><a href="../distage/distage-framework-docker.html#overview" class="header">Overview</a></li>
    <li><a href="../distage/distage-framework-docker.html#config-api" class="header">Config API</a></li>
    <li><a href="../distage/distage-framework-docker.html#availability-and-health-checks" class="header">Availability and Health Checks</a></li>
    <li><a href="../distage/distage-framework-docker.html#usage-in-integration-tests" class="header">Usage in Integration Tests</a></li>
    <li><a href="../distage/distage-framework-docker.html#docker-container-environment" class="header">Docker Container Environment</a></li>
    <li><a href="../distage/distage-framework-docker.html#docker-metadata" class="header">Docker Metadata</a></li>
    <li><a href="../distage/distage-framework-docker.html#docker-container-networks" class="header">Docker Container Networks</a></li>
    <li><a href="../distage/distage-framework-docker.html#docker-client-configuration" class="header">Docker Client Configuration</a></li>
    <li><a href="../distage/distage-framework-docker.html#container-reuse" class="header">Container Reuse</a></li>
    <li><a href="../distage/distage-framework-docker.html#examples" class="header">Examples</a></li>
    <li><a href="../distage/distage-framework-docker.html#tips" class="header">Tips</a></li>
    <li><a href="../distage/distage-framework-docker.html#troubleshooting" class="header">Troubleshooting</a></li>
    <li><a href="../distage/distage-framework-docker.html#references" class="header">References</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 1.1.0*
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../distage/distage-framework-docker.html#distage-framework-docker" class="header">distage-framework-docker</a>
  <ul>
    <li><a href="../distage/distage-framework-docker.html#key-features" class="header">Key Features</a></li>
    <li><a href="../distage/distage-framework-docker.html#dependencies" class="header">Dependencies</a></li>
    <li><a href="../distage/distage-framework-docker.html#overview" class="header">Overview</a></li>
    <li><a href="../distage/distage-framework-docker.html#config-api" class="header">Config API</a></li>
    <li><a href="../distage/distage-framework-docker.html#availability-and-health-checks" class="header">Availability and Health Checks</a></li>
    <li><a href="../distage/distage-framework-docker.html#usage-in-integration-tests" class="header">Usage in Integration Tests</a></li>
    <li><a href="../distage/distage-framework-docker.html#docker-container-environment" class="header">Docker Container Environment</a></li>
    <li><a href="../distage/distage-framework-docker.html#docker-metadata" class="header">Docker Metadata</a></li>
    <li><a href="../distage/distage-framework-docker.html#docker-container-networks" class="header">Docker Container Networks</a></li>
    <li><a href="../distage/distage-framework-docker.html#docker-client-configuration" class="header">Docker Client Configuration</a></li>
    <li><a href="../distage/distage-framework-docker.html#container-reuse" class="header">Container Reuse</a></li>
    <li><a href="../distage/distage-framework-docker.html#examples" class="header">Examples</a></li>
    <li><a href="../distage/distage-framework-docker.html#tips" class="header">Tips</a></li>
    <li><a href="../distage/distage-framework-docker.html#troubleshooting" class="header">Troubleshooting</a></li>
    <li><a href="../distage/distage-framework-docker.html#references" class="header">References</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#distage-framework-docker" name="distage-framework-docker" class="anchor"><span class="anchor-link"></span></a>distage-framework-docker</h1>
<div class="toc ">
<ul>
  <li><a href="../distage/distage-framework-docker.html#key-features" class="header">Key Features</a></li>
  <li><a href="../distage/distage-framework-docker.html#dependencies" class="header">Dependencies</a></li>
  <li><a href="../distage/distage-framework-docker.html#overview" class="header">Overview</a>
  <ul>
    <li><a href="../distage/distage-framework-docker.html#1-create-a-containerdef" class="header">1. Create a <code>ContainerDef</code></a></li>
    <li><a href="../distage/distage-framework-docker.html#2-declare-container-components" class="header">2. Declare Container Components</a></li>
    <li><a href="../distage/distage-framework-docker.html#3-include-the-dockersupportmodule" class="header">3. Include the <code>DockerSupportModule</code></a></li>
  </ul></li>
  <li><a href="../distage/distage-framework-docker.html#config-api" class="header">Config API</a>
  <ul>
    <li><a href="../distage/distage-framework-docker.html#modifyconfig" class="header">modifyConfig</a></li>
    <li><a href="../distage/distage-framework-docker.html#dependoncontainer" class="header">dependOnContainer</a></li>
  </ul></li>
  <li><a href="../distage/distage-framework-docker.html#availability-and-health-checks" class="header">Availability and Health Checks</a></li>
  <li><a href="../distage/distage-framework-docker.html#usage-in-integration-tests" class="header">Usage in Integration Tests</a></li>
  <li><a href="../distage/distage-framework-docker.html#docker-container-environment" class="header">Docker Container Environment</a></li>
  <li><a href="../distage/distage-framework-docker.html#docker-metadata" class="header">Docker Metadata</a></li>
  <li><a href="../distage/distage-framework-docker.html#docker-container-networks" class="header">Docker Container Networks</a>
  <ul>
    <li><a href="../distage/distage-framework-docker.html#1-create-a-containernetworkdef" class="header">1. Create a <code>ContainerNetworkDef</code></a></li>
    <li><a href="../distage/distage-framework-docker.html#2-add-to-container-config" class="header">2. Add to Container Config</a></li>
    <li><a href="../distage/distage-framework-docker.html#container-network-reuse" class="header">Container Network Reuse</a></li>
  </ul></li>
  <li><a href="../distage/distage-framework-docker.html#docker-client-configuration" class="header">Docker Client Configuration</a></li>
  <li><a href="../distage/distage-framework-docker.html#container-reuse" class="header">Container Reuse</a>
  <ul>
    <li><a href="../distage/distage-framework-docker.html#matching-containers-for-reuse" class="header">Matching Containers for Reuse</a></li>
    <li><a href="../distage/distage-framework-docker.html#configuring-reuse" class="header">Configuring Reuse</a></li>
    <li><a href="../distage/distage-framework-docker.html#improving-reuse-performance" class="header">Improving Reuse Performance</a></li>
  </ul></li>
  <li><a href="../distage/distage-framework-docker.html#examples" class="header">Examples</a></li>
  <li><a href="../distage/distage-framework-docker.html#tips" class="header">Tips</a></li>
  <li><a href="../distage/distage-framework-docker.html#troubleshooting" class="header">Troubleshooting</a></li>
  <li><a href="../distage/distage-framework-docker.html#references" class="header">References</a></li>
</ul>
</div>
<h3><a href="#key-features" name="key-features" class="anchor"><span class="anchor-link"></span></a>Key Features</h3>
<ul>
  <li>Provides Docker containers as resources</li>
  <li>Reasonable defaults with flexible configuration</li>
  <li>Excellent for providing Docker implementations of services for integration tests</li>
</ul>
<h3><a href="#dependencies" name="dependencies" class="anchor"><span class="anchor-link"></span></a>Dependencies</h3>
<p>Add the <code>distage-framework-docker</code> library:</p><dl class="dependency"><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">libraryDependencies += "io.7mind.izumi" %% "distage-framework-docker" % "1.1.0-SNAPSHOT"</code></pre></dd></dl>
<h3><a href="#overview" name="overview" class="anchor"><span class="anchor-link"></span></a>Overview</h3>
<p>Usage of <code>distage-framework-docker</code> generally follows these steps:</p>
<ol>
  <li>Create <a href="/latest/snapshot/api/izumi/distage/docker/ContainerDef.html" title="izumi.distage.docker.ContainerDef"><code>`ContainerDef`</code></a>s for the containers the  application requires</li>
  <li>Create a module that declares the container component</li>
  <li>Include the <a href="/latest/snapshot/api/izumi/distage/docker/modules/DockerSupportModule.html" title="izumi.distage.docker.modules.DockerSupportModule"><code>`DockerSupportModule`</code></a> in  the application&rsquo;s modules</li>
</ol>
<h4><a href="#1-create-a-containerdef" name="1-create-a-containerdef" class="anchor"><span class="anchor-link"></span></a>1. Create a <code>ContainerDef</code></h4>
<p>The <a href="/latest/snapshot/api/izumi/distage/docker/ContainerDef.html" title="izumi.distage.docker.ContainerDef"><code>`ContainerDef`</code></a> is a trait used to define a Docker container. Extend this trait and provide an implementation of the <code>config</code> method.</p>
<p>The required parameters for <code>Config</code> are:</p>
<ul>
  <li><code>image</code> - the docker image to use</li>
  <li><code>ports</code> - ports to map on the docker container</li>
</ul>
<p>See <a href="/latest/snapshot/api/izumi/distage/docker/Docker$$ContainerConfig.html" title="izumi.distage.docker.Docker.ContainerConfig"><code>`Docker.ContainerConfig[Tag]`</code></a> for additional parameters.</p>
<p>Example <a href="https://hub.docker.com/_/postgres/">postgres</a> container definition:</p>
<pre class="prettyprint"><code class="language-scala">import izumi.distage.docker.{ContainerDef, Docker}

object PostgresDocker extends ContainerDef {
  val primaryPort: Docker.DockerPort = Docker.DockerPort.TCP(5432)

  override def config: Config = {
    Config(
      registry = Some(&quot;public.ecr.aws&quot;),
      image = &quot;docker/library/postgres:12.6&quot;,
      ports = Seq(primaryPort),
      env = Map(&quot;POSTGRES_PASSWORD&quot; -&gt; &quot;postgres&quot;),
    )
  }
}
</code></pre>
<h4><a href="#2-declare-container-components" name="2-declare-container-components" class="anchor"><span class="anchor-link"></span></a>2. Declare Container Components</h4>
<p>To use this container, a module that declares this component is required:</p>
<p>Use <a href="/latest/snapshot/api/izumi/distage/docker/ContainerDef.html#make" title="izumi.distage.docker.ContainerDef"><code>`make`</code></a> for binding in a <code>ModuleDef</code>:</p>
<pre class="prettyprint"><code class="language-scala">import distage.ModuleDef
import izumi.reflect.TagK

class PostgresDockerModule[F[_]: TagK] extends ModuleDef {
  make[PostgresDocker.Container].fromResource {
    PostgresDocker.make[F]
  }
}
object PostgresDockerModule {
  def apply[F[_]: TagK] = new PostgresDockerModule[F]
}
</code></pre>
<h4><a href="#3-include-the-dockersupportmodule" name="3-include-the-dockersupportmodule" class="anchor"><span class="anchor-link"></span></a>3. Include the <code>DockerSupportModule</code></h4>
<p>Include the <code>izumi.distage.docker.modules.DockerSupportModule</code> module in the application modules. This module contains required component declarations and initializes the <code>Docker.ClientConfig</code>.</p>
<pre class="prettyprint"><code class="language-scala">import cats.effect.IO
import com.typesafe.config.ConfigFactory
import distage.Injector
import distage.config.AppConfigModule
import izumi.distage.docker.modules.DockerSupportModule
import izumi.logstage.distage.LogIOModule
import logstage.LogRouter

object DistageFrameworkModules extends ModuleDef {
  // required for docker
  include(DockerSupportModule[IO])

  // standard distage framework modules
  include(AppConfigModule(ConfigFactory.defaultApplication()))
  include(LogIOModule[IO](LogRouter(), true))
}
</code></pre>
<p>The required framework modules plus <code>PostgresDockerModule</code> is sufficient to depend on Docker containers:</p>
<pre class="prettyprint"><code class="language-scala">def minimalExample = {
  val applicationModules = new ModuleDef {
    include(PostgresDockerModule[IO])
    include(DistageFrameworkModules)
  }

  Injector[IO]().produceRun(applicationModules) {
    container: PostgresDocker.Container =&gt;
      val port = container.availablePorts.first(PostgresDocker.primaryPort)
      IO(println(s&quot;postgres is available on port ${port}&quot;))
  }
}

minimalExample.unsafeRunSync()(cats.effect.unsafe.IORuntime.global)
// postgres is available on port AvailablePort(10.1.0.146,41833)
</code></pre>
<p>If the <code>DockerSupportModule</code> is not included in an application then a get of a Docker container dependent resource will fail with a <code>izumi.distage.model.exceptions.runtime.ProvisioningException</code>.</p>
<h3><a href="#config-api" name="config-api" class="anchor"><span class="anchor-link"></span></a>Config API</h3>
<p>The <a href="/latest/snapshot/api/izumi/distage/docker/DockerContainer$$DockerProviderExtensions.html" title="izumi.distage.docker.DockerContainer.DockerProviderExtensions"><code>`DockerProviderExtensions`</code></a> provides additional APIs for modiying the container definition.</p>
<h4><a href="#modifyconfig" name="modifyconfig" class="anchor"><span class="anchor-link"></span></a>modifyConfig</h4>
<p>Use <a href="/latest/snapshot/api/izumi/distage/docker/DockerContainer$$DockerProviderExtensions.html#modifyConfig" title="izumi.distage.docker.DockerContainer.DockerProviderExtensions"><code>`modifyConfig`</code></a> to modify the configuration of a container. The modifier is instantiated to a <code>Functoid</code>, which will summon any additional dependencies.</p>
<p>For example, to change the user of the PostgreSQL container:</p>
<pre class="prettyprint"><code class="language-scala">class PostgresRunAsAdminModule[F[_]: TagK] extends ModuleDef {
  make[PostgresDocker.Container].fromResource {
    PostgresDocker
      .make[F]
      .modifyConfig {
        () =&gt; (old: PostgresDocker.Config) =&gt;
          old.copy(user = Some(&quot;admin&quot;))
      }
  }
}
</code></pre>
<p>Suppose <code>HostPostgresData</code> is a component provided by the application modules. This path can be added to the PostgreSQL container&rsquo;s mounts by adding to the additional dependencies of the provider magnet:</p>
<pre class="prettyprint"><code class="language-scala">final case class HostPostgresData(path: String)

class PostgresWithMountsDockerModule[F[_]: TagK] extends ModuleDef {
  make[PostgresDocker.Container].fromResource {
    PostgresDocker.make[F].modifyConfig {
      (hostPostgresData: HostPostgresData) =&gt;
        (old: PostgresDocker.Config) =&gt;
          val dataMount = Docker.Mount(hostPostgresData.path, &quot;/var/lib/postgresql/data&quot;)
          old.copy(mounts = old.mounts :+ dataMount)
    }
  }
}
</code></pre>
<h4><a href="#dependoncontainer" name="dependoncontainer" class="anchor"><span class="anchor-link"></span></a>dependOnContainer</h4>
<p><a href="/latest/snapshot/api/izumi/distage/docker/DockerContainer$$DockerProviderExtensions.html#dependOnContainer" title="izumi.distage.docker.DockerContainer.DockerProviderExtensions"><code>`dependOnContainer`</code></a> adds a dependency on a given Docker container. <code>distage</code> ensures the requested container is available before the dependent.</p>
<p>For example, suppose a system under test requires both PostgreSQL and Elasticsearch. One option is to use <code>dependOnContainer</code> to declare the Elasticsearch container depends on the PostgreSQL container:</p>
<pre class="prettyprint"><code class="language-scala">object ElasticSearchDocker extends ContainerDef {
  val ports = Seq(9200, 9300)

  override def config: Config = {
    Config(
      image = &quot;docker.elastic.co/elasticsearch/elasticsearch:7.7.0&quot;,
      ports = ports.map(Docker.DockerPort.TCP(_)),
      env = Map(&quot;discovery.type&quot; -&gt; &quot;single-node&quot;)
    )
  }
}

class ElasticSearchPlusPostgresModule[F[_]: TagK] extends ModuleDef {
  make[PostgresDocker.Container].fromResource {
    PostgresDocker.make[F]
  }

  make[ElasticSearchDocker.Container].fromResource {
    ElasticSearchDocker.make[F].dependOnContainer(PostgresDocker)
  }
}
</code></pre>
<p>Another example of dependencies between containers is in the &ldquo;Docker Container Networks&rdquo; section later in this document.</p>
<h3><a href="#availability-and-health-checks" name="availability-and-health-checks" class="anchor"><span class="anchor-link"></span></a>Availability and Health Checks</h3>
<p>The <code>healthCheck</code> properties of <a href="/latest/snapshot/api/izumi/distage/docker/Docker$$ContainerConfig.html" title="izumi.distage.docker.Docker.ContainerConfig"><code>Docker.ContainerConfig</code></a> configure the health checks. A container resource will not be provided if the health checks did not succeed at acquire time. These are used to determine if an existing container can be used and if starting a fresh container succeeded.</p>
<p>By default, the <code>healthCheck</code> is a port check of the ports from the container config. There are several standard checks provided in <a href="/latest/snapshot/api/izumi/distage/docker/healthcheck/ContainerHealthCheck$.html" title="izumi.distage.docker.healthcheck.ContainerHealthCheck"><code>ContainerHealthCheck</code></a> that can be combined to cover many common cases.</p>
<p>The <a href="/latest/snapshot/api/izumi/distage/docker/DockerContainer.html#availablePorts" title="izumi.distage.docker.DockerContainer"><code>availablePorts</code></a> property of the container resource are the mapped ports that passed the health check. This is a map from a <code>Docker.DockerPort</code> provided in the config to a host and port. For example:</p>
<pre class="prettyprint"><code class="language-scala">val port = container.availablePorts.first(PostgresDocker.primaryPort)
</code></pre>
<p>would be a host and port mapped to the Postgres container&rsquo;s primary port that have passed the health check.</p>
<h3><a href="#usage-in-integration-tests" name="usage-in-integration-tests" class="anchor"><span class="anchor-link"></span></a>Usage in Integration Tests</h3>
<p>A common use case is using Docker containers to provide service implementations for integration test, such as using a PostgreSQL container for verifying an application that uses a PostgreSQL database.</p>
<p>Consider the example application below. This application is written to depend on a <a href="https://tpolecat.github.io/doobie/">doobie</a> <code>Transactor</code>, which is constructed from a <code>PostgresServerConfig</code>.</p>
<pre class="prettyprint"><code class="language-scala">import cats.effect.Async
import doobie.Transactor
import doobie.syntax.connectionio._
import doobie.syntax.string._

final class PostgresExampleApp(
  xa: Transactor[IO]
) {
  def plusOne(a: Int): IO[Int] = {
    sql&quot;select ${a} + 1&quot;.query[Int].unique.transact(xa)
  }

  val run: IO[Unit] = {
    for {
      v &lt;- plusOne(1)
      _ &lt;- IO(println(s&quot;1 + 1 = ${v}.&quot;))
    } yield ()
  }
}

// the postgres configuration used to construct the Transactor
final case class PostgresServerConfig(
  host: String,
  port: Int,
  database: String,
  username: String,
  password: String,
)

object TransactorFromConfigModule extends ModuleDef {
  make[Transactor[IO]].from {
    (config: PostgresServerConfig, async: Async[IO]) =&gt;

      Transactor.fromDriverManager[IO](
        driver = &quot;org.postgresql.Driver&quot;,
        url    = s&quot;jdbc:postgresql://${config.host}:${config.port}/${config.database}&quot;,
        user   = config.username,
        pass   = config.password,
      )(async)
  }
}
</code></pre>
<p>Note that the above code is agnostic of environment. Provided a <code>PostgresServerConfig</code>, the <code>Transactor</code> needed by <code>PostgresExampleApp</code> can be constructed.</p>
<p>An integration test would use a module that provides the <code>PostgresServerConfig</code> from a <code>PostgresDocker.Container</code>:</p>
<pre class="prettyprint"><code class="language-scala">object PostgresUsingDockerModule extends ModuleDef {
  make[PostgresServerConfig].from {
    container: PostgresDocker.Container =&gt; {
      val knownAddress = container.availablePorts.first(PostgresDocker.primaryPort)
      PostgresServerConfig(
        host     = knownAddress.hostString,
        port     = knownAddress.port,
        database = &quot;postgres&quot;,
        username = &quot;postgres&quot;,
        password = &quot;postgres&quot;,
      )
    }
  }

  make[PostgresDocker.Container].fromResource {
    PostgresDocker.make[IO]
  }
}
</code></pre>
<p>Using <code>distage-testkit</code> the test would be written like this:</p>
<pre class="prettyprint"><code class="language-scala">import izumi.distage.testkit.scalatest.{AssertCIO, Spec1}
import distage.DIKey

class PostgresExampleAppIntegrationTest extends Spec1[IO] with AssertCIO {
  override def config = super.config.copy(
    moduleOverrides = new ModuleDef {
      include(TransactorFromConfigModule)
      include(PostgresUsingDockerModule)
      include(DistageFrameworkModules)
      make[PostgresExampleApp]
    },
    memoizationRoots = Set(
      DIKey[PostgresServerConfig]
    ),
  )

  &quot;distage docker&quot; should {

    &quot;support integration tests using containers&quot; in {
      app: PostgresExampleApp =&gt;
        for {
          v &lt;- app.plusOne(1)
          _ &lt;- assertIO(v == 2)
        } yield ()
    }

  }
}
</code></pre>
<p>Typically, this would be run by the test runner. For completeness, the example can be run directly using:</p>
<pre class="prettyprint"><code class="language-scala">def postgresDockerIntegrationExample = {
  val applicationModules = new ModuleDef {
    include(TransactorFromConfigModule)
    include(PostgresUsingDockerModule)
    include(DistageFrameworkModules)

    make[PostgresExampleApp]
  }

  Injector[IO]().produceRun(applicationModules) {
    app: PostgresExampleApp =&gt;
      app.run
  }
}

postgresDockerIntegrationExample.unsafeRunSync()(cats.effect.unsafe.IORuntime.global)
// 1 + 1 = 2.
</code></pre>
<h3><a href="#docker-container-environment" name="docker-container-environment" class="anchor"><span class="anchor-link"></span></a>Docker Container Environment</h3>
<p>The container config (<a href="/latest/snapshot/api/izumi/distage/docker/Docker$$ContainerConfig.html" title="izumi.distage.docker.Docker.ContainerConfig"><code>Docker.ContainerConfig</code></a>) defines the container environment. Of note are the environment variables, command of entrypoint, and working directory properties:</p>
<ul>
  <li><code>env: Map[String, String]</code> - environment variables to setup in container</li>
  <li><code>cmd: Seq[String]</code> - command of entrypoint</li>
  <li><code>cwd: Option[String]</code> - working directory in container</li>
</ul>
<p>Once defined in a <code>ContainerDef</code> the config may be modified by distage modules. See <code>modifyConfig</code> above for one mechanism.</p>
<p>The container ports will also add to the configured environment variables:</p>
<ul>
  <li><code>DISTAGE_PORT_&lt;protocol&gt;_&lt;originalPort&gt;</code> are the host ports allocated for the container</li>
</ul>
<h3><a href="#docker-metadata" name="docker-metadata" class="anchor"><span class="anchor-link"></span></a>Docker Metadata</h3>
<p>The host ports allocated for the container are also added to the container metadata as labels. These labels follow the pattern <code>distage.port.&lt;protocol&gt;.&lt;originalPort&gt;</code>. The value is the integer port number.</p>
<h3><a href="#docker-container-networks" name="docker-container-networks" class="anchor"><span class="anchor-link"></span></a>Docker Container Networks</h3>
<p><code>distage-framework-docker</code> can automatically manage <a href="https://docs.docker.com/engine/reference/commandline/network/">Docker networks</a>.</p>
<p>To connect containers to the same Docker network, use a <a href="/latest/snapshot/api/izumi/distage/docker/ContainerNetworkDef.html" title="izumi.distage.docker.ContainerNetworkDef"><code>`ContainerNetworkDef`</code></a>:</p>
<ol>
  <li>Create a <code>ContainerNetworkDef</code>.</li>
  <li>Add the network to each container&rsquo;s config.</li>
</ol>
<p>This will ensure the containers are all connected to the network. Assuming no reuse, distage will create the required network and add each container to that network.</p>
<h4><a href="#1-create-a-containernetworkdef" name="1-create-a-containernetworkdef" class="anchor"><span class="anchor-link"></span></a>1. Create a <code>ContainerNetworkDef</code></h4>
<p>A minimal <a href="/latest/snapshot/api/izumi/distage/docker/ContainerNetworkDef.html" title="izumi.distage.docker.ContainerNetworkDef"><code>`ContainerNetworkDef`</code></a> uses the default configuration.</p>
<pre class="prettyprint"><code class="language-mdoc:to-string">object TestClusterNetwork extends ContainerNetworkDef {
  override def config: Config = Config()
}
</code></pre>
<p>By default this object identifies the network. The associated tag type uniquely identifies this network within the application. In addition, any created network will have a label with this name in Docker.</p>
<h4><a href="#2-add-to-container-config" name="2-add-to-container-config" class="anchor"><span class="anchor-link"></span></a>2. Add to Container Config</h4>
<p>A container will be connected to all networks in the <code>networks</code> of the <code>config</code>. The method <a href="/latest/snapshot/api/izumi/distage/docker/DockerContainer$$DockerProviderExtensions.html#connectToNetwork" title="izumi.distage.docker.DockerContainer.DockerProviderExtensions"><code>`connectToNetwork`</code></a> adds a dependency on a network defined by a <code>ContainerNetworkDef</code>, as in this example:</p>
<pre class="prettyprint"><code class="language-mdoc:to-string">class TestClusterNetworkModule[F[_]: TagK] extends ModuleDef {
  make[TestClusterNetwork.Network].fromResource {
    TestClusterNetwork.make[F]
  }
  make[PostgresDocker.Container].fromResource {
    PostgresDocker.make[F].connectToNetwork(TestClusterNetwork)
  }
  make[ElasticSearchDocker.Container].fromResource {
    ElasticSearchDocker.make[F].dependOnContainer(PostgresDocker).connectToNetwork(TestClusterNetwork)
  }
}
</code></pre>
<p>The use of <code>connectToNetwork</code> automatically adds a dependency on <code>TestClusterNetwork.Network</code> to each container.</p>
<h4><a href="#container-network-reuse" name="container-network-reuse" class="anchor"><span class="anchor-link"></span></a>Container Network Reuse</h4>
<p>Container networks, like containers, are reused by default. If there is an existing network that matches a definition then that network will be used. This can be disabled by setting the <code>reuse</code> configuration to <code>DockerReusePolicy.KillOnExitNoReuse</code>:</p>
<pre class="prettyprint"><code class="language-mdoc:to-string">object AlwaysFreshNetwork extends ContainerNetworkDef {
  override def config: Config = Config(reuse = Docker.DockerReusePolicy.KillOnExitNoReuse)
}
</code></pre>
<p>For an existing network to be reused, the config and object name at time of creation must be the match the current configuration value and object.</p>
<h3><a href="#docker-client-configuration" name="docker-client-configuration" class="anchor"><span class="anchor-link"></span></a>Docker Client Configuration</h3>
<p>The <a href="/latest/snapshot/api/izumi/distage/docker/Docker$$ClientConfig.html" title="izumi.distage.docker.Docker.ClientConfig"><code>`Docker.ClientConfig`</code></a> is the configuration of the Docker client used. Including the module <code>DockerSupportModule</code> will provide a <code>Docker.ClientConfig</code>.</p>
<p>There are two primary mechanisms to change the <code>Docker.ClientConfig</code> provided by <code>DockerSupportModule</code>:</p>
<ol>
  <li>Provide a <code>docker</code> configuration in the <code>application.conf</code>:</li>
</ol>
<pre class="prettyprint"><code class="language-hocon"># include the default configuration
include &quot;docker-reference.conf&quot;

# override docker object fields
docker {
  globalReuse = &quot;always-kill&quot;
}
</code></pre>
<ol>
  <li>Override the <code>DockerSupportModule</code> using <code>overriddenBy</code>:</li>
</ol>
<pre class="prettyprint"><code class="language-scala">import izumi.distage.docker.Docker
import izumi.distage.docker.Docker.DockerReusePolicy

class CustomDockerConfigExampleModule[F[_]: TagK] extends ModuleDef {
  include(DockerSupportModule[F] overriddenBy new ModuleDef {
    make[Docker.ClientConfig].from {
      Docker.ClientConfig(
        globalReuse       = DockerReusePolicy.ReuseEnabled,
        useRemote         = true,
        useGlobalRegistry = true,
        remote            = Some(
          Docker.RemoteDockerConfig(
            host      = &quot;tcp://localhost:2376&quot;,
            tlsVerify = true,
            certPath  = &quot;/home/user/.docker/certs&quot;,
            config    = &quot;/home/user/.docker&quot;,
          )
        ),
        globalRegistry = Some(&quot;index.docker.io&quot;), // docker hub default registry
        registryConfigs = List(
            Docker.DockerRegistryConfig(
              registry = &quot;index.docker.io&quot;,
              username = &quot;docker_user&quot;,
              password = &quot;i_love_docker&quot;,
              email    = Some(&quot;dockeruser@github.com&quot;),
            ),
            Docker.DockerRegistryConfig(
              registry = &quot;your.registry&quot;,
              username = &quot;my_registry_user&quot;,
              password = &quot;i_love_my_registry&quot;,
            ),
        ),
      )
    }
  })
}
</code></pre>
<h3><a href="#container-reuse" name="container-reuse" class="anchor"><span class="anchor-link"></span></a>Container Reuse</h3>
<p>By default acquiring a container resource does not always start a fresh container. Likewise on releasing the resource the container will not be destroyed. When a container resource is acquired, the Docker system is inspected to determine if a matching container is already executing. If a matching container is found this container is referenced by the <code>ContainerResource</code>. Otherwise a fresh container is started. In both cases the acquired <code>ContainerResource</code> will have passed configured health checks.</p>
<h4><a href="#matching-containers-for-reuse" name="matching-containers-for-reuse" class="anchor"><span class="anchor-link"></span></a>Matching Containers for Reuse</h4>
<p>For an existing container to be reused, all the following must be true:</p>
<ul>
  <li>The current client config has <code>globalReuse == DockerReusePolicy.ReuseEnabled</code></li>
  <li>The container config has <code>reuse == DockerReusePolicy.ReuseEnabled</code></li>
  <li>The running container was created for reuse.</li>
  <li>The running container uses the same image as the container config.</li>
  <li>All ports requested in the container config must be mapped for the running container.</li>
</ul>
<h4><a href="#configuring-reuse" name="configuring-reuse" class="anchor"><span class="anchor-link"></span></a>Configuring Reuse</h4>
<p><code>DockerReusePolicy</code> has 2 possible values:</p>
<ul>
  <li><code>ReuseEnabled</code>: the resource (container or network) will be always freed after use and existing matching containers will not be reused</li>
  <li><code>ReuseDisabled</code>: the resource will be always be freed after use but existing matching containers will be reused</li>
</ul>
<p>The <code>ContainerDef.Config.reuse</code> should be <code>DockerReusePolicy.ReuseDisabled</code> to disable reuse for a specific container. While <code>Docker.ClientConfig.globalReuse</code> should be <code>DockerReusePolicy.ReuseDisabled</code> to disable reuse throughout the application.</p>
<h4><a href="#improving-reuse-performance" name="improving-reuse-performance" class="anchor"><span class="anchor-link"></span></a>Improving Reuse Performance</h4>
<p>When utilizing reuse, the performance cost of inspecting the Docker system can be avoided using memoization roots. For example, in this integration test the container resource is not reconstructed for each test. Because the resource is not reconstructed there is no repeated inspection of the Docker system.</p>
<pre class="prettyprint"><code class="language-scala">class NoReuseByMemoizationExampleTest extends Spec1[IO] {
  override def config = super.config.copy(
    moduleOverrides = new ModuleDef {
      include(DistageFrameworkModules)
      include(PostgresDockerModule[IO])
    },
    memoizationRoots = Set(
      DIKey[PostgresDocker.Container]
    )
  )

  &quot;distage docker&quot; should {
    &quot;provide a fresh container resource&quot; in { c: PostgresDocker.Container =&gt;
      val port = c.availablePorts.first(PostgresDocker.primaryPort)
      IO(println(s&quot;port ${port}&quot;))
    }

    &quot;provide the same resource&quot; in { c: PostgresDocker.Container =&gt;
      val port = c.availablePorts.first(PostgresDocker.primaryPort)
      IO(println(s&quot;port ${port}&quot;))
    }
  }
}
</code></pre>
<h3><a href="#examples" name="examples" class="anchor"><span class="anchor-link"></span></a>Examples</h3>
<p>The <code>distage-example</code> project uses <code>distage-framework-docker</code> to provide a <a href="https://github.com/7mind/distage-example/blob/develop/src/test/scala/leaderboard/PostgresDockerModule.scala">PostgresDockerModule</a>.</p>
<p>The <code>distage-framework-docker</code> project contains example <code>ContainerDef</code>s and modules for various services under <a href="https://github.com/7mind/izumi/tree/develop/distage/distage-framework-docker/src/main/scala/izumi/distage/docker/examples"><code>izumi.distage.docker.examples</code></a> namespace.</p>
<h3><a href="#tips" name="tips" class="anchor"><span class="anchor-link"></span></a>Tips</h3>
<p>To kill all containers spawned by <code>distage</code>, use the following command:</p>
<pre class="prettyprint"><code class="language-shell">docker rm -f $(docker ps -q -a -f &#39;label=distage.type&#39;)
</code></pre>
<h3><a href="#troubleshooting" name="troubleshooting" class="anchor"><span class="anchor-link"></span></a>Troubleshooting</h3>
<pre><code>// izumi.distage.model.exceptions.runtime.ProvisioningException: Provisioner stopped after 1 instances, 2/14 operations failed:
//  - {type.izumi.distage.docker.DockerClientWrapper[=λ %0 → IO[+0]]} (distage-framework-docker.md:40), MissingInstanceException: Instance is not available in the object graph: {type.izumi.distage.docker.DockerClientWrapper[=λ %0 → IO[+0]]}.
</code></pre>
<p>This error means that <a href="/latest/snapshot/api/izumi/distage/docker/modules/DockerSupportModule.html" title="izumi.distage.docker.modules.DockerSupportModule"><code>`DockerSupportModule`</code></a> hasn&rsquo;t been <code>include</code>d with the application modules.</p>
<p><code>DockerClientWrapper</code> component is provided by <a href="/latest/snapshot/api/izumi/distage/docker/modules/DockerSupportModule.html" title="izumi.distage.docker.modules.DockerSupportModule"><code>`izumi.distage.docker.modules.DockerSupportModule`</code></a>.</p>
<h3><a href="#references" name="references" class="anchor"><span class="anchor-link"></span></a>References</h3>
<ul>
  <li>Introduced in <a href="https://github.com/7mind/izumi/releases/tag/v0.9.13">release 0.9.13</a></li>
  <li>An <a href="https://github.com/7mind/distage-livecode/pull/2/files">example PR</a> showing how to use them.</li>
  <li>The <code>distage-example</code> <a href="https://github.com/7mind/distage-example/blob/develop/src/test/scala/leaderboard/PostgresDockerModule.scala">PostgresDockerModule</a>.</li>
</ul>
</div>
<div>
<a href="https://github.com/7mind/izumi/tree/master/doc/microsite/target/mdoc/distage/distage-framework-docker.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
1.1.0*
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../distage/distage-framework.html" title="distage-framework" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
distage-framework
</span>
</div>
</a>
<a href="../distage/distage-testkit.html" title="distage-testkit" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
distage-testkit
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
<div class="md-footer-copyright__highlight">
7mind.io
</div>
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="../assets/javascripts/application.583bbe55.js"></script>
<script src="../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../."}})</script>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
